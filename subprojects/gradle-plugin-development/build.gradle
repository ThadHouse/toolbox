import com.jfrog.bintray.gradle.tasks.BintrayUploadTask
import org.gradle.api.publish.maven.internal.artifact.FileBasedMavenArtifact

import java.text.SimpleDateFormat

plugins {
    id 'java-gradle-plugin'
    id 'com.jfrog.bintray'
    id 'maven-publish'
}

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
    withSourcesJar()
    withJavadocJar()
}

gradlePlugin {
    plugins {
        javaGradlePlugin {
            id = 'dev.gradleplugins.java-gradle-plugin'
            implementationClass = 'dev.gradleplugins.internal.plugins.JavaGradlePluginDevelopmentPlugin'
        }
    }
}

//// Supported by the development plugins
//tasks.named('publishPlugins') {
//    dependsOn('shadowJar')
//}
//tasks.named('jar') {
//    enabled = false
//}
//afterEvaluate {
//    publishing {
//        publications {
//            withType(MavenPublication) {
//                if (name == 'pluginMaven') {
//                    setArtifacts([tasks.getByName('shadowJar')])
//                }
//            }
//        }
//    }
//}
//
repositories {
    jcenter()
//    gradlePluginPortal()
}

//def stubConfiguration = configurations.create('stub') {
//    visible = false
//    canBeResolved = true
//    canBeConsumed = false
//    attributes.attribute(Usage.USAGE_ATTRIBUTE, objects.named(Usage, 'stub'))
//}
//
dependencies {
//    add(stubConfiguration.name, project(':gradle-plugin-development-stubs'))

    compileOnly(project(':gradle-api')) {
        attributes {
            attribute(Attribute.of('dev.gradleplugins.gradleAbi', String), '6.2.1')
        }
    }

//    implementation 'com.gradle.publish:plugin-publish-plugin:0.10.1'
////    functionalTestImplementation project(':gradle-fixtures')
//    compileOnly project(':gradle-plugin-development-annotation')
//    shaded 'org.ow2.asm:asm:6.0'
//    shaded 'org.ow2.asm:asm-util:6.0'
//
////    functionalTestImplementation project(':gradle-plugin-development-annotation')
}

//tasks.named('pluginUnderTestMetadata', PluginUnderTestMetadata) {
//    getPluginClasspath().from(configurations.shaded)
//}
//
//sourceSets {
//    main {
//        resources.srcDir(stubConfiguration)
//    }
//}
//
//String withoutSnapshot(String version) {
//    return version.toString().replace('-SNAPSHOT', '')
//}
//
//def generatorTask = tasks.register('createVersionInformation') {
//    outputs.dir(project.layout.buildDirectory.dir('generatedSources'))
//    inputs.property('version', project.version)
//    inputs.property('group', project.group)
//    inputs.property('name', project.project(':gradle-fixtures').name)
//    doLast {
//        project.layout.buildDirectory.file('generatedSources/TestFixtures.java').get().asFile.text = """package dev.gradleplugins.internal;
//
//public class TestFixtures {
//    public static final boolean released = ${!project.version.toString().contains("-SNAPSHOT")};
//    public static final String notation = "${project.group}:${project.project(":gradle-fixtures").name}:${project.version}";
//    public static final String apiVersion = "0.0.12";
//    public static final String currentVersion = "${project.version}";
//}
//"""
//    }
//}
//tasks.named('compileJava', JavaCompile) {
//    dependsOn(generatorTask)
//}
//sourceSets.main {
//    java.srcDir(project.layout.buildDirectory.dir("generatedSources"))
//}
//
//pluginBundle {
//    website = 'https://gradleplugins.dev/'
////    description = "A sets of highly opinionated plugins to kick start any Gradle plugin project."
//    tags = ['gradle', 'gradle-plugins', 'development']
//
//    plugins {
//        javaGradlePluginDevelopment {
//            id = 'dev.gradleplugins.java-gradle-plugin'
//            description = 'Fast track development of Gradle plugins in Java'
//            displayName = 'Fast Gradle plugin development in Java'
//            tags = ["gradle", "gradle-plugins", "development", "java"]
//        }
//        groovyGradlePluginDevelopment {
//            id = 'dev.gradleplugins.groovy-gradle-plugin'
//            description = 'Fast track development of Gradle plugins in Groovy'
//            displayName = 'Fast Gradle plugin development in Groovy'
//            tags = ['gradle', 'gradle-plugins', 'development', 'groovy']
//        }
//        kotlinGradlePluginDevelopment {
//            id = 'dev.gradleplugins.kotlin-gradle-plugin'
//            description = 'Fast track development of Gradle plugins in Kotlin'
//            displayName = 'Fast Gradle plugin development in Kotlin'
//            tags = ['gradle', 'gradle-plugins', 'development', 'kotlin']
//        }
//    }
//}
//
//publishing {
//    repositories {
//        mavenLocal()
//    }
//}
//
//tasks.register('release') {
//    dependsOn('publishPlugins')
//}
//
//tasks.register('install') {
//    dependsOn('publishToMavenLocal')
//}
//
//shadedArtifact {
//    packagesToRelocate.set(['org.objectweb.asm', 'org.objectweb.asm.util'])
//}
//
//// TODO: Add smoke test of the final binaires to make sure it contains the expected plugin ids, etc
////   - Also check the dependencies inside the POM to make sure we aren't leaking anything

// Temporary workaround for https://github.com/bintray/gradle-bintray-plugin/issues/229
PublishingExtension publishing = project.extensions.getByType(PublishingExtension)
project.tasks.withType(BintrayUploadTask).configureEach {
    doFirst {
        publishing.publications.withType(MavenPublication).each { publication ->
            File moduleFile = project.buildDir.toPath()
                    .resolve("publications/${publication.name}/module.json").toFile()

            if (moduleFile.exists()) {
                publication.artifact(new FileBasedMavenArtifact(moduleFile) {
                    @Override
                    protected String getDefaultExtension() {
                        return "module"
                    }
                })
            }
        }
    }
}

private String resolveProperty(Project project, String envVarKey, String projectPropKey) {
    Object propValue = System.getenv().get(envVarKey);

    if (propValue != null) {
        return propValue.toString();
    }

    propValue = project.findProperty(projectPropKey);
    if (propValue != null) {
        return propValue.toString();
    }

    return null;
}


afterEvaluate {
    bintray {
        user = resolveProperty(project, "BINTRAY_USER", "dev.gradleplugins.bintray.user")
        key = resolveProperty(project, "BINTRAY_KEY", "dev.gradleplugins.bintray.key")
        publications = publishing.publications.collect { it.name }

        publish = true
        override = System.getProperties().containsKey('force')

        pkg {
            repo = 'distributions'
            name = 'dev.gradleplugins:gradle-development-plugins'
            desc = project.description
            userOrg = 'gradle-plugins'
            websiteUrl = 'https://nokee.dev'
            issueTrackerUrl = 'https://github.com/gradle-plugins/toolbox/issues'
            vcsUrl = 'https://github.com/gradle-plugins/toolbox.git'
            labels = ['gradle', 'gradle-api', 'gradle-plugins']
            licenses = ['Apache-2.0']
            publicDownloadNumbers = false

            version {
                released = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZZ").format(new Date())
                // TODO: Sign artifacts
                gpg {
                    sign = false
                    passphrase = resolveProperty(project, "GPG_PASSPHRASE", "dev.gradleplugins.bintray.gpgPassphrase")
                }
            }
        }
    }
}

tasks.register('release') {
    dependsOn('bintrayUpload')
}